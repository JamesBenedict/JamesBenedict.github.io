YUI.add("cameraroll-edit-dialog-dates-view",function(e){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){this.dateTaken={},this.originalDateTaken={},this.datePosted={},this.originalDatePosted={},this.hadMultipleValues=!0,this.granularityStrings={circa:this.intlMessage({intlName:"common.CIRCA"}),sometimeIn:this.intlMessage({intlName:"common.SOMETIME_IN"})},this.months=[this.intlMessage({intlName:"common.CIRCA"}),this.intlMessage({intlName:"common.SOMETIME_IN"}),this.intlMessage({intlName:"common.JANUARY"}),this.intlMessage({intlName:"common.FEBRUARY"}),this.intlMessage({intlName:"common.MARCH"}),this.intlMessage({intlName:"common.APRIL"}),this.intlMessage({intlName:"common.MAY"}),this.intlMessage({intlName:"common.JUNE"}),this.intlMessage({intlName:"common.JULY"}),this.intlMessage({intlName:"common.AUGUST"}),this.intlMessage({intlName:"common.SEPTEMBER"}),this.intlMessage({intlName:"common.OCTOBER"}),this.intlMessage({intlName:"common.NOVEMBER"}),this.intlMessage({intlName:"common.DECEMBER"})],this.monthsEnglish=[this.granularityStrings.circa,this.granularityStrings.sometimeIn,"January","February","March","April","May","June","July","August","September","October","November","December"];var n=1825,r=2004,i,s=[],o=[],u=parseInt((new Date).getFullYear(),10);while(u>=n)o.push(u.toString()),u--;u=parseInt((new Date).getFullYear(),10);while(u>=r)s.push(u.toString()),u--;this.takenYears=o,this.postedYears=s,this.days=["-"];for(i=1;i<32;i++)this.days.push(i);if(t.commonData&&t.commonData.dateTaken){this.originalDateTaken=e.clone(t.commonData.dateTaken,!0),this.originalDateTaken.granularity=this.dateTaken.granularity=parseInt(t.commonData.dateTakenGranularity,10),t.commonData.dateTaken.m?this.originalDateTaken.m=this.months[t.commonData.dateTaken.m+1]:this.dateTaken.granularity===6?this.originalDateTaken.m=this.months[1]:this.dateTaken.granularity===8&&(this.originalDateTaken.m=this.months[0]);switch(this.dateTaken.granularity){case 4:this.dateTaken.year=t.commonData.dateTaken.y,this.dateTaken.monthName=this.months[t.commonData.dateTaken.m+1],t.commonData.dateTaken.y&&t.commonData.dateTaken.m&&(this.hadMultipleValues=!1);break;case 6:this.dateTaken.year=t.commonData.dateTaken.y,this.dateTaken.monthName=this.months[1],t.commonData.dateTaken.y&&(this.hadMultipleValues=!1);break;case 8:this.dateTaken.year=t.commonData.dateTaken.y,this.dateTaken.monthName=this.months[0],t.commonData.dateTaken.y&&(this.hadMultipleValues=!1);break;case 10:case 20:break;default:"y"in t.commonData.dateTaken&&(this.dateTaken.year=t.commonData.dateTaken.y),"m"in t.commonData.dateTaken&&(this.dateTaken.monthName=this.months[t.commonData.dateTaken.m+1]),"d"in t.commonData.dateTaken&&(this.dateTaken.day=t.commonData.dateTaken.d),"h"in t.commonData.dateTaken&&(this.dateTaken.hour=this.zeroPad(t.commonData.dateTaken.h)),"i"in t.commonData.dateTaken&&(this.dateTaken.minute=this.zeroPad(t.commonData.dateTaken.i)),"s"in t.commonData.dateTaken&&(this.dateTaken.second=this.zeroPad(t.commonData.dateTaken.s))}}return this.dateTaken.granularity===0&&t.commonData.dateTaken.y!==undefined&&t.commonData.dateTaken.m!==undefined&&t.commonData.dateTaken.d!==undefined&&(this.hadMultipleValues=!1),t.commonData&&t.commonData.dateCreate&&(this.originalDatePosted=e.clone(t.commonData.dateCreate,!0),this.originalDatePosted.m=this.months[t.commonData.dateCreate.m+1],this.datePosted.year=t.commonData.dateCreate.y,this.datePosted.monthName=this.months[t.commonData.dateCreate.m+1],this.datePosted.day=t.commonData.dateCreate.d,this.datePosted.hour=this.zeroPad(t.commonData.dateCreate.h),this.datePosted.minute=this.zeroPad(t.commonData.dateCreate.i),this.datePosted.second=this.zeroPad(t.commonData.dateCreate.s)),this},loadState:function(){return this.appContext.getModel("person-models",this.appContext.getViewer().nsid).then(function(e){this.set("accountStartDate",e.getValue("dateCreated"))}.bind(this))},buildContainer:function(){this.setContainerHTML(this.templates("cameraroll-edit-dialog-dates")({dateTaken:this.dateTaken,datePosted:this.datePosted}))},activate:function(){var e=this.get("container"),t=this;return e.delegate("click",function(e){t.handleDoneClick(e)},".ui-dialog-button-done"),e.delegate("click",function(e){t.handleCloseClick(e)},".ui-dialog-button-close"),e.all(".year").on("click",function(e){var n=e.target.ancestor(".date-inputs").hasClass("date-taken-inputs"),r=e.target.ancestor("div",!0);t.createDropdown(r,n?t.takenYears:t.postedYears,n?t.dateTaken:t.datePosted,134,11,"year")}),e.all(".month").on("click",function(e){var n=e.target.ancestor(".date-inputs").hasClass("date-taken-inputs"),r=e.target.ancestor("div",!0),i=[],s;for(s=0;s<t.months.length;s++)i[s]={},i[s].value=t.monthsEnglish[s],i[s].display=t.months[s];t.createDropdown(r,n?i:i.slice(2),n?t.dateTaken:t.datePosted,134,11,"monthName")}),e.all(".day").on("click",function(e){var n=e.target.ancestor(".date-inputs").hasClass("date-taken-inputs"),r=e.target.ancestor("div",!0);t.createDropdown(r,n?t.days:t.days.slice(1),n?t.dateTaken:t.datePosted,134,11,"day")}),e.all(".date-hour, .date-minute, .date-second").on("keydown",function(e){e.charCode!==190&&e.charCode>31&&(e.charCode<48||e.charCode>57)&&(e.charCode<96||e.charCode>105)&&(e.charCode<37||e.charCode>40)&&e.charCode!==110&&e.charCode!==8&&e.charCode!==46&&e.preventDefault()}),t.registerEventHandler(t.on("validateDates",t.validateNewDates,t)),this.setDateRows(e.one(".date-taken-inputs"),this.dateTaken),this.setDateRows(e.one(".date-posted-inputs"),this.datePosted),this},createDropdown:function(t,n,r,i,s,o){if(t.getAttribute("disabled")==="true")return;var u=e.Node.create("<div></div>"),a=e.Node.create("<div></div>"),f=e.Node.create("<span></span>"),l=this.get("container"),c=l.ancestor(".cameraroll-edit-dialog"),h=c.get("clientWidth"),p=c.get("clientHeight"),d=e.config.win.innerHeight,v=i,m=t.get("offsetLeft"),g=t.get("offsetTop"),y=t.get("offsetWidth"),b=t.get("offsetHeight"
),w=25,E=270,S=p+E*2,x,T,N,C,k,L,A=this,O,M;C=this.templates("date-dropdown")({list:n}),u.setHTML(C),u.hide(),u.addClass("date-dropdown"),u.setStyle("width",v),d<S&&(x=(d-p)/2,T=p-g-b,T+x<E&&(N=T+x-b,N<b*2&&(N=b*2),u.setStyle("maxHeight",N))),u.setY(g+30),u.setX(m+y-v),f.addClass("date-dropdown-arrow"),f.setY(g+21),f.setX(m+y-w),a.addClass("date-dropdown-curtain"),a.setStyle("width",h),a.setStyle("height",p),l.append(a),a.append(f),a.append(u),k=u.delegate("click",function(e){A.onDropdownRowSelected(t,k,a,r,o,e)},"li"),a.on("click",function(e){A.onCloseDropdown(e,k,a)}),r&&r[o]&&(L=u.one('li[value="'+r[o]+'"]'),L&&L.addClass("selected-item")),u.show(),r&&r[o]&&L&&(M=L.getXY(),O=u.getXY(),M[1]-O[1]>=265&&(u.getDOMNode().scrollTop=M[1]-O[1]))},onDropdownRowSelected:function(e,t,n,r,i,s){s.target.get("tagName")==="SPAN"&&(s.target=s.target.ancestor("li"));if(!s.target.hasClass("selected-item")){var o=s.target.getAttribute("value"),u=s.target.get("text");e.one(".date-value").setHTML(u),e.setAttribute("data-"+i,o),r[i]=o,this.onCloseDropdown(s,t,n),this.setDateRows(e,r)}},onCloseDropdown:function(e,t,n){t.detach(),n.remove(!0)},validateNewDates:function(){var t=this,n="?",r="?",i=[{selector:".month",value:"data-monthName",attributeValue:!0,dateFormat:"MMM",commonDataKey:"m"},{selector:".day",value:"data-day",attributeValue:!0,dateFormat:"DD",commonDataKey:"d"},{selector:".year",value:"data-year",attributeValue:!0,dateFormat:"YYYY",commonDataKey:"y"},{selector:".date-hour",value:"value",dateFormat:"HH",defaultValue:0,validate:!0,min:0,max:23,commonDataKey:"h"},{selector:".date-minute",value:"value",dateFormat:"mm",validate:!0,min:0,max:59,commonDataKey:"i"},{selector:".date-second",value:"value",dateFormat:"ss",validate:!0,min:0,max:59,commonDataKey:"s"}],s,o,u,a,f="",l="",c="",h="",p="",d="",v={},m,g=e.one(".cameraroll-edit-dialog-dates-view"),y=g.one(".date-taken-inputs"),b=g.one(".date-posted-inputs"),w=!0,E=!0,S=!0,x=!0,T,N=this.appContext.getViewer().prefs.timezonePref,C=!1,k=this.dateTaken.granularity>=10,L=this.monthsEnglish.map(function(e){return e.toUpperCase()}),A=this.months.map(function(e){return e.toUpperCase()}),O,M=function(e,t){var r=t===""?n:t,i;e==="m"&&(i=L.indexOf((t||"").toUpperCase()),i<0&&(i=A.indexOf((t||"").toUpperCase())),i>0&&(r=i-1)),v[e]=r};O=function(){var e=(v.y||n)+"-"+(v.m||n)+"-"+(v.d||n)+" "+(v.h||n)+":"+(v.i||n)+":"+(v.s||n);return v={},e},i.forEach(function(e){s=y.one(e.selector)[e.attributeValue?"getAttribute":"get"](e.value).trim(),o=t.originalDateTaken[e.commonDataKey];if(o===null||o===undefined)o=n;s!==""||e.commonDataKey!=="h"&&e.commonDataKey!=="i"&&e.commonDataKey!=="s"?s==="-"&&(s=n):s=r,k&&e.commonDataKey==="m"&&s!=o&&(E=!1),E=E&&s==o;if(s===t.granularityStrings.circa||s===t.granularityStrings.sometimeIn){C=!0,t.dateTaken.granularity=s===t.granularityStrings.circa?8:6;return}if(s===n&&e.dateFormat==="DD"&&!C&&(t.originalDateTaken.granularity===4||t.dateTaken.day!==undefined&&t.originalDateTaken.day)){C=!0,t.dateTaken.granularity=4;return}if(s===r)w=!0,M(e.commonDataKey,r);else if(s!==n){if(e.validate){try{T=parseInt(s,10),w=w&&T>=e.min&&T<=e.max}catch(i){w=!1}if(!w)return!1}f+=s+" ",l+=e.dateFormat+" ",M(e.commonDataKey,s)}else if(e.defaultValue)f+=e.defaultValue+" ",l+=e.dateFormat+" ",M(e.commonDataKey,e.defaultValue);else{if(C)return;E||(w=!1)}});if(f&&l&&!E&&!w){t.fire("subviewViewEvent","camerarollEditDialog:datesInvalid","invalidDateTaken");return}p=O(),i.forEach(function(e){s=b.one(e.selector)[e.attributeValue?"getAttribute":"get"](e.value).trim(),o=t.originalDatePosted[e.commonDataKey];if(o===null||o===undefined)o=n;s!==""||e.commonDataKey!=="h"&&e.commonDataKey!=="i"&&e.commonDataKey!=="s"?s==="-"&&(s=n):s=r,x=x&&s==o;if(s===r)S=!0,M(e.commonDataKey,r);else if(s!==n){if(e.validate){try{T=parseInt(s,10),S=S&&T>=e.min&&T<=e.max}catch(i){S=!1}if(!S)return!1}c+=s+" ",h+=e.dateFormat+" ",M(e.commonDataKey,s)}else e.defaultValue?(c+=e.defaultValue+" ",h+=e.dateFormat+" ",M(e.commonDataKey,e.defaultValue)):x||(S=!1)});if(c&&h&&!S&&!x){t.fire("subviewViewEvent","camerarollEditDialog:datesInvalid","invalidDatePosted");return}d=O(),f!==""&&(u=e.moment(f,l||"dd-mm-yyyy")),m=this.dateTaken.granularity,N.name?a=e.moment.tz(c,h,N.name):a=e.moment(c,h);if(!u&&!a){this.fire("subviewViewEvent","camerarollEditDialog:datesEmpty");return}if(a&&a.year()!==0&&a.isValid()&&!x){var _=this.get("accountStartDate");if(a.isBefore(_)){this.fire("subviewViewEvent","camerarollEditDialog:datesInvalid","invalidDatePostedBeforeAccount",_);return}}if(E&&x){this.fire("subviewViewEvent","camerarollEditDialog:datesEmpty");return}if(u&&a&&!E&&!x){if(a.diff(e.moment(),"days")>1){this.fire("subviewViewEvent","camerarollEditDialog:datesInvalid","datePostedFuture");return}this.fire("subviewViewEvent","camerarollEditDialog:datesToBeUpdated",u.format("YYYY-MM-DD HH:mm:ss"),a.format("X"),m,p,d)}else if(u&&!E){if(u.diff(e.moment(),"days")>2){this.fire("subviewViewEvent","camerarollEditDialog:datesInvalid","dateTakenFuture");return}this.fire("subviewViewEvent","camerarollEditDialog:datesToBeUpdated",u.format("YYYY-MM-DD HH:mm:ss"),null,m,p)}else{if(!a||!!x){this.fire("subviewViewEvent","camerarollEditDialog:datesInvalid","both");return}if(a.diff(e.moment(),"days")>1){this.fire("subviewViewEvent","camerarollEditDialog:datesInvalid","datePostedFuture");return}this.fire("subviewViewEvent","camerarollEditDialog:datesToBeUpdated",null,a.format("X"),null,null,d)}},setDateRows:function(e,t){var n=e.ancestor(".date-inputs",!0),r,i,s,o,u,a,f,l,c,h;n&&(r=n.one(".year").getAttribute("data-year"),i=n.one(".month").getAttribute("data-monthName"),s=n.one(".day"),o=n.one(".date-hour"),u=n.one(".date-minute"),f=n.one(".date-second"),h=n.one(".time-fields"),l=i===this.granularityStrings.circa,c=i===this.granularityStrings.sometimeIn,a=n.hasClass("date-taken-inputs"),l||c?a&&(this.hadMultipleValues||(t.granularity=l?8:6),s.one(".date-value").setHTML("-"),s.setAttribute("data-day","-"),t.day="-",s.setAttribute
("disabled",!0),s.addClass("hide-day"),o.setAttribute("value","-"),o.setAttribute("disabled",!0),u.setAttribute("value","-"),u.setAttribute("disabled",!0),f.setAttribute("value","-"),f.setAttribute("disabled",!0),h.addClass("hide-time")):r&&i===""?a&&(this.hadMultipleValues||(t.granularity=6),o.setAttribute("value","-"),o.setAttribute("disabled",!0),u.setAttribute("value","-"),u.setAttribute("disabled",!0),f.setAttribute("value","-"),f.setAttribute("disabled",!0),h.addClass("hide-time")):(s.removeAttribute("disabled"),s.removeClass("hide-day"),s.getAttribute("data-day")==="-"?(this.hadMultipleValues||(t.granularity=4),o.setAttribute("value",""),o.setAttribute("disabled",!0),u.setAttribute("value",""),u.setAttribute("disabled",!0),f.setAttribute("value",""),f.setAttribute("disabled",!0),h.addClass("hide-time")):(this.hadMultipleValues||(!a||s.getAttribute("data-day")!==""||this.dateTaken.granularity!==10&&this.dateTaken.granularity!==20?t.granularity=0:t.granularity=this.dateTaken.granularity),o.setAttribute("value",t.hour||""),o.removeAttribute("disabled"),u.setAttribute("value",t.minute||""),u.removeAttribute("disabled"),f.setAttribute("value",t.second||""),f.removeAttribute("disabled"),h.removeClass("hide-time"))))},zeroPad:function(e){return e<10?"0"+e:e}})},"@VERSION@",{requires:["flickr-view","flickr-promise","hermes-template-cameraroll-edit-dialog-dates","cameraroll-edit-dialog-dates-css","hermes-template-date-dropdown","hermes-template-validation-error","validation-error-css","moment","moment-timezone"],optional:[],langBundles:["common","photo-page-scrappy"]});
YUI.add("cameraroll-edit-dialog-body-view",function(e){var t,n={},r={},i={},s,o,u=[],a=[],f=[],l=[],c=[],h=e.config.flickr.api.max_concurrent_photos_api_can_handle,p=e.config.flickr.api.max_tags_in_photo,d=e.config.flickr.api.max_concurrent_photo_date_sets,v=[],m,g,y=!1;s={tagAddition:!1,tagRemoval:!1,peopleAddition:!1,peopleRemoval:!1,photoUpdate:!1,permissionsUpdate:!1,datesUpdate:!0},o={tagsRetry:10,peopleRetry:10,photoRetry:10,permissionsRetry:10,datesRetry:10},t={debug:!1,css:{safetyLevel:".c-charm-item-safetylevel .ui-dropdown",privacy:".c-charm-item-privacy .ui-dropdown",license:".photo-license-info .ui-dropdown",commentingPermission:".commenting-permission .ui-dropdown",addMetaPermission:".add-meta-permission .ui-dropdown"}},e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return e.commonData.tags=e.commonData.tags||[],e.commonData.people=e.commonData.people||[],this.set("originalFieldValues",e.commonData),this},subviewConfig:{"cameraroll-edit-dialog-people-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1},"cameraroll-edit-dialog-dates-view":{requiredToShowOnClient:!1,requiredToShowOnServer:!1}},loadState:function(){var t=this;return(new e.FlickrPromise({personInPhotoModel:t.appContext.getModelRegistry("person-in-photo-models"),person:t.appContext.getModelRegistry("person-models")})).then(function(e){var n=t.appContext.getViewer();t.set("personInPhotoModel",e.personInPhotoModel),t.set("person",e.person);if(n.signedIn)return e.person.get(n.nsid).then(function(e){t.set("me",e)})})},buildContainer:function(){var e,t=this,n,r,i,s,o,u,a,f=this.get("selectedPhotosIDs").length,l;return n=t.intlMessage({intlName:"cameraroll.TITLE_PLACEHOLDER",selectedCount:f}),r=t.intlMessage({intlName:"cameraroll.DESCRIPTION_PLACEHOLDER",selectedCount:f}),i=t.intlMessage({intlName:"cameraroll.EDIT_PRIVACY_LABEL",selectedCount:f}),s=t.intlMessage({intlName:"cameraroll.EDIT_SAFETY_LABEL",selectedCount:f}),o=t.intlMessage({intlName:"cameraroll.EDIT_COMMENTING_PERMISSION_LABEL",selectedCount:f}),u=t.intlMessage({intlName:"cameraroll.EDIT_TAGGING_PERMISSION_LABEL",selectedCount:f}),a=t.intlMessage({intlName:"cameraroll.EDIT_COPYRIGHT_LABEL",selectedCount:f}),l=this.get("originalFieldValues"),l.description&&(l.description=l.description.replace(/&quot;/g,'"').replace(/&amp;/g,"&").replace(/&gt;/g,">").replace(/&lt;/g,"<")),e=this.templates("cameraroll-edit-dialog-body")({originalFieldValues:l,titlePlaceholder:n,descriptionPlaceholder:r,privacyLabel:i,safetyLabel:s,commentingPermissionLabel:o,taggingPermissionLabel:u,licenseLabel:a,"cameraroll-edit-dialog-people-view":this.subviews["cameraroll-edit-dialog-people-view"].get("container"),"cameraroll-edit-dialog-dates-view":this.subviews["cameraroll-edit-dialog-dates-view"].get("container")}),this.setContainerHTML(e),this},activate:function(){var i=this,s=this.get("container"),o=s.one(".title-desc-container"),u=this.get("originalFieldValues"),a=this.subviews["cameraroll-edit-dialog-people-view"],f=this.subviews["cameraroll-edit-dialog-dates-view"],l,c,h;this.privacyDd=new e.Views.Dropdown({appContext:this.appContext,container:s.one(t.css.privacy),selected:this.getDataFromOriginalValues("privacy"),defaultLabel:this.intlMessage({intlName:"cameraroll.MULTIPLE_SELECT_VALUE"}),disabled:!1}),this.privacyDd.on("open",function(t){i.fire("subviewViewEvent","make in view",i.privacyDd.get("container")),e.rapidTracker.beacon(i.name,"camerarollTrayEditModalPrivacyMenuClick")}),this.privacyDd.on("close",function(e){i.fire("subviewViewEvent","close in view")}),this.privacyDd.on("selected",function(e){r.privacy=i.mapPrivacy(e.clicked.value)}),this.commentingPermissionDd=new e.Views.Dropdown({appContext:this.appContext,container:s.one(t.css.commentingPermission),selected:u.permComment,defaultLabel:this.intlMessage({intlName:"cameraroll.MULTIPLE_SELECT_VALUE"}),disabled:!1}),this.commentingPermissionDd.on("open",function(t){i.fire("subviewViewEvent","make in view",i.commentingPermissionDd.get("container")),e.rapidTracker.beacon(i.name,"camerarollTrayEdit:CommentPermissionMenuClick")}),this.commentingPermissionDd.on("close",function(e){i.fire("subviewViewEvent","close in view")}),this.commentingPermissionDd.on("selected",function(e){r.commenting=e.clicked.value}),this.addMetaPermissionDd=new e.Views.Dropdown({appContext:this.appContext,container:s.one(t.css.addMetaPermission),selected:u.permAddmeta,defaultLabel:this.intlMessage({intlName:"cameraroll.MULTIPLE_SELECT_VALUE"}),disabled:!1}),this.addMetaPermissionDd.on("open",function(t){i.fire("subviewViewEvent","make in view",i.addMetaPermissionDd.get("container")),e.rapidTracker.beacon(i.name,"camerarollTrayEdit:AddMetaPermissionMenuClick")}),this.addMetaPermissionDd.on("close",function(e){i.fire("subviewViewEvent","close in view")}),this.addMetaPermissionDd.on("selected",function(e){r.addMeta=e.clicked.value}),this.safetyLevelDd=new e.Views.Dropdown({appContext:this.appContext,container:s.one(t.css.safetyLevel),selected:u.adultness,defaultLabel:this.intlMessage({intlName:"cameraroll.MULTIPLE_SELECT_VALUE"}),disabled:!1}),this.safetyLevelDd.on("open",function(t){i.fire("subviewViewEvent","make in view",i.safetyLevelDd.get("container")),e.rapidTracker.beacon(i.name,"camerarollTrayEdit:safetyMenuClick")}),this.safetyLevelDd.on("close",function(e){i.fire("subviewViewEvent","close in view")}),this.safetyLevelDd.on("selected",function(e){n.safetyLevel=e.clicked.value}),this.licenseDd=new e.Views.Dropdown({appContext:this.appContext,container:s.one(t.css.license),selected:u.license,defaultLabel:this.intlMessage({intlName:"cameraroll.MULTIPLE_SELECT_VALUE"}),disabled:!1}),this.licenseDd.on("open",function(t){i.fire("viewEvent","make in view",i.licenseDd.get("container")),e.rapidTracker.beacon(i.name,"camerarollTrayEdit:LicenseMenuClick")}),this.licenseDd.on("close",function(e){i.fire("viewEvent","close in view")}),this.licenseDd.on("selected",function(e){n.license=e.clicked
.value}),this.on("destroy",function(){i.safetyLevelDd.destroy(),i.privacyDd.destroy(),i.licenseDd.destroy(),i.commentingPermissionDd.destroy(),i.addMetaPermissionDd.destroy()}),i.registerEventHandler(i.on("doSave",i.checkDates,i)),i.registerEventHandler(o.on("focus",function(){o.addClass("focused")})),i.registerEventHandler(o.on("blur",function(){o.removeClass("focused")})),i.registerEventHandler(s.one(".edit-photos-tags").on("keydown",function(e){e.charCode===13&&(e.preventDefault(),i.addTagsToDialog(this.get("value")))}));if(u.tags&&u.tags.length)for(l=0,c=u.tags.length;l<c;l++)i.addTagsToDialog(u.tags[l].tagRaw,!0);i.registerEventHandler(s.one(".tags-container").delegate("click",i.removeTag,".remove-tag",i)),a&&a.activate();if(u.people&&u.people.length)for(l=0,c=u.people.length;l<c;l++)h=u.people[l],a.addTemporaryPersonTag(h.realname||h.characterName,h.nsid,e.URLHelper.getBuddyIconURL(h.nsid,h.iconfarm,h.iconserver),h.ispro||h.isPro),a.contacts.hideFromSearch(h.nsid);return f&&f.activate(),this},checkDates:function(e){this.parentModal=e,this.subviews["cameraroll-edit-dialog-dates-view"].fire("validateDates")},callNextInQueue:function(){var e,t=this;if(v.length!==0)return m=!0,e=v.shift(),e().then(function(){return t.callNextInQueue()},function(){return t.callNextInQueue()});m=!1},addToQueue:function(e){v.push(e),m||this.callNextInQueue()},getDataFromOriginalValues:function(e){var t=this.get("originalFieldValues"),n;if(e==="privacy"){if(!("isPublic"in t&&"isFriend"in t&&"isFamily"in t))return;t.isPublic?n="public":t.isFriend&&t.isFamily?n="friendsandfamily":t.isFriend?n="friends":t.isFamily?n="family":n="private"}else this.appContext.warn("["+this.name+"] Unknown type passed to getDataFromOriginalValues");return n},mapPrivacy:function(e){var t,n,r,i,s;t=[["public",["isPublic"]],["friendsandfamily",["isVisibleByFriends","isVisibleByFamily"]],["friends",["isVisibleByFriends"]],["family",["isVisibleByFamily"]],["private",[]]];if(typeof e=="object"){for(n=0,r=t.length;n<r;n++){i=t[n];if(!i[1].length||i[1].every(function(t){return!!e[t]}))return i[0]}return null}s={};for(n=0,r=t.length;n<r;n++)i=t[n],i[1].forEach(function(t){s[t]=i[0]===e?!0:s[t]||!1});return s},processTag:function(t){var n=this,r,i,s;s=t.replace(/"(.*?)"/g,function(e,t){return t=t.replace(/(,)/g,function(e,t){return t="{COMMA}",t}),t=t.replace(/(\s+)/g,function(e,t){return t="{WHITESPACE"+t.charCodeAt(0)+"}",t}),t}),s.indexOf(",")>-1?i=s.split(/,/):i=s.split(/\s+/);for(r in i)i[r]=i[r].replace(/\{WHITESPACE([0-9]+)\}/g,function(e,t){return t=String.fromCharCode(t),t}),i[r]=i[r].replace(/\{COMMA\}/g,function(e,t){return t=",",t});return e.Array.each(i,function(t,n){i[n]=e.Lang.trim(t)}),i=e.Array.filter(i,function(e,t){if(e.length>0)return!0}),i=e.Array.unique(i,function(e,t,r){return n.cleanTag(e)===n.cleanTag(t)}),i},addTagsToDialog:function(t,n){var r=this,i=this.get("container"),s=this.get("originalFieldValues").tags,o,f,l,c,h,d;if(n){this.renderTag(t),this.resetTagInput();return}if(t==='""'||t==="''"){this.resetTagInput();return}o=this.processTag(t),o=o.filter(function(t){return t=r.cleanTag(t),u.indexOf(t)>-1?!1:e.Array.find(s,function(e){return t===e.tagClean})?e.Array.find(a,function(e){return t===e.tagClean}):!0}),h=u.length,s.length+h+o.length-a.length>p&&i.one(".max-tags-reached").removeClass("hidden");for(d=0;d<o.length;d++){f=o[d],l=this.cleanTag(f);if(s.length+h+d-a.length>=p)break;e.Array.find(s,function(e){return e.tagClean===l})?(e.Array.find(a,function(e,t){if(e.tagClean===l)return c=t,!0}),a.splice(c,1)):u.push(f),this.renderTag(f)}this.resetTagInput(!0)},removeTag:function(t){t.preventDefault();var n,r,i,s=this.get("container"),o=this.get("originalFieldValues").tags,f,l=s.one(".tags-list"),c=s.one(".machine-tags-list");i=t.target.ancestor(".tag"),n=i.one(".tag-text").get("text"),r=this.cleanTag(n),i.remove(),f=e.Array.find(o,function(e){return e.tagClean===r}),f?a.push(f):u.splice(u.indexOf(n),1),o.length+u.length<p&&s.one(".max-tags-reached").hasClass("hidden")&&s.one(".max-tags-reached").addClass("hidden"),c.getDOMNode().childElementCount?l.getDOMNode().childElementCount||l.addClass("hidden"):c.addClass("hidden")},cleanTag:function(e){return e.replace(/\s/g,"").toLowerCase()},renderTag:function(t){var n=this.get("container"),r=n.one(".tags-list"),i=n.one(".machine-tags-list"),s=/^[a-zA-Z]\w*:[a-zA-Z]\w*=.+/;s.test(t)?(i.removeClass("hidden"),i.append('<li class="tag"><span class="tag-text">'+e.flutil.escapeInput(t,"html")+'</span><a class="remove-tag"><i class="delete-tag" title="Delete"></i></a></li>')):(r.removeClass("hidden"),r.append('<li class="tag"><span class="tag-text">'+e.flutil.escapeInput(t,"html")+'</span><a class="remove-tag" href="#"><i class="delete-tag" title="Delete"></i></a></li>'))},resetTagInput:function(e){var t=this.get("container").one(".edit-photos-tags");t.set("value",""),e&&t.focus()},saveTags:function(t){var n,r=this,i=0,f,l,h,p=this.get("container"),d=p.one(".edit-photos-tags"),v,m=[],g=[],y,b,w=50,E;d.get("value")!==""&&this.addTagsToDialog(d.get("value")),n=t||this.get("selectedPhotosIDs"),b=n.length,y=Math.ceil(b/w),v=y,e.rapidTracker.beacon(r.name,"camerarollTrayEdit:TagsAdded"),r.appContext.getModelRegistry("tag-models").then(function(t){for(l=0;l<y;l++)f=n.slice(i,w+i),i+=w,u.length?(e.Array.each(u,function(e,t){u[t]='"'+e+'"'}),t.remoteCreate({photoId:f,tags:u,fullResponse:1}).then(function(t){v--;if(t&&t.length>0){e.Flog.warn(r.name,"editing tags failed",t);for(h=0;h<t.length;h++)t[h].code===106&&o.tagsRetry>0?(m.push(t[h].photoId),m=m.filter(function(e,t){return m.indexOf(e)===t})):t[h].code===2?g.push(t[h].photoId):c.push({id:t[h].photoId,code:t[h].code,api:"tagsAdd"})}if(!v){if(m.length!==0&&o.tagsRetry>0)return s.tagAddition=!1,o.tagsRetry--,r.saveTags(m);g.length>0&&c.push({id:"",photosFailed:g.length,code:"2",api:"maxTagsInPhoto"}),s.tagAddition=!0,u=[],r.checkIfAPICallsAreDone()}},function(t){e.Flog.warn(r.name,"editing tags failed",t),v--,t.photoIds.forEach(function(
e){o.tagsRetry>0&&(t.clientTimeout||t.message==="XHR error")?m.indexOf(e)===-1&&m.push(e):c.push({id:e,code:"noRetry",api:"tagsAdd"})});if(!v){if(m.length!==0&&o.tagsRetry>0)return s.tagAddition=!1,o.tagsRetry--,r.saveTags(m);s.tagAddition=!0,u=[],r.checkIfAPICallsAreDone()}})):s.tagAddition=!0,a.length?(E=[],e.Array.each(a,function(e,t){E.push(e.id)}),t.remoteDelete({photoIds:f,globalTagIds:E}).then(function(e){s.tagRemoval=!0,a=[],r.checkIfAPICallsAreDone()},function(e){r.checkIfAPICallsAreDone()})):s.tagRemoval=!0})},savePeople:function(t){var n,r=this,i=0,u,a,h,p,d,v,m=[],g=[],y=[],b=[],w=[],E,S,x,T=50;n=t||this.get("selectedPhotosIDs"),x=n.length,S=Math.ceil(x/T),E=S,e.rapidTracker.beacon(r.name,"camerarollTrayEdit:PeopleAdded");for(a=0;a<S;a++)u=n.slice(i,T+i),i+=T,f.length?this.get("personInPhotoModel").remoteCreate({photoId:u.join(","),userId:f.join(","),addedBy:r.get("me").getValue("nsid"),coords:{x:0,y:0,w:0,h:0},fullResponse:1}).then(function(t){E--;if(t){e.Flog.warn(r.name,"editing people tags failed",t);if(t.photosAllUsers&&t.photosAllUsers.length>0)for(h=0;h<t.photosAllUsers.length;h++)w.push(t.photosAllUsers[h].photoId);if(t.usersAllPhotos&&t.usersAllPhotos.length>0)for(p=0;p<t.usersAllPhotos.length;p++)b.indexOf(t.usersAllPhotos[p].userId)<0&&b.push(t.usersAllPhotos[p].userId);if(t.otherErrors&&t.otherErrors.length>0)for(d=0;d<t.otherErrors.length;d++)t.otherErrors[d].code===106&&o.peopleRetry>0?(m.push(t.otherErrors[d].photoId),m=m.filter(function(e,t){return m.indexOf(e)===t})):t.otherErrors[d].code===5||t.otherErrors[d].code===3?y.push(t.otherErrors[d].userId):c.push({id:t.otherErrors[d].photoId,code:t.otherErrors[d].code,api:"peopleTagsAdd"})}if(!E){if(m.length!==0&&o.peopleRetry>0)return s.peopleAddition=!1,o.peopleRetry--,r.savePeople(m);y.length>0&&(y=y.filter(function(e,t){return y.indexOf(e)===t}),c.push({id:"",usersFailed:y.length,code:"5",api:"unableToAddPersonToPhoto"})),b.length>0&&c.push({id:"",usersFailed:b.length,code:"3",api:"peopleUserError"}),w.length>0&&c.push({id:"",photosFailed:w.length,code:"2",api:"peoplePhotoError"}),f=[],s.peopleAddition=!0,r.checkIfAPICallsAreDone()}},function(t){e.Flog.warn(r.name,"editing people tags failed",t),E--,g=t.photoIds.split(",");if(o.peopleRetry>0&&(t.clientTimeout||t.message==="XHR error"))m=m.concat(g),m=m.filter(function(e,t){return m.indexOf(e)===t});else for(v=0;v<g.length;v++)c.push({id:g[v],code:"noRetry",api:"peopleTagsAdd"});if(!E){if(m.length!==0&&o.peopleRetry>0)return s.peopleAddition=!1,o.peopleRetry--,r.savePeople(m);f=[],s.peopleAddition=!0,r.checkIfAPICallsAreDone()}}):s.peopleAddition=!0,l.length?this.get("personInPhotoModel").remoteDelete({photoIds:u.join(","),userIds:l.join(",")}).then(function(t){e.Flog.debug("people removal success:",t),s.peopleRemoval=!0,l=[],r.checkIfAPICallsAreDone()},function(t){e.Flog.debug("people removal FAIL:",t),r.checkIfAPICallsAreDone()}):s.peopleRemoval=!0},savePhotosUpdates:function(t){var r,i=0,u,a,f,l,p,d,v,m,g,y,b,w=[],E=[],S,x,T,N=this;r=t||this.get("selectedPhotosIDs"),T=r.length,x=Math.ceil(T/h),m=x,n.safetyLevel&&e.rapidTracker.beacon(N.name,"camerarollTrayEdit:SafetyChanged"),n.license&&e.rapidTracker.beacon(N.name,"camerarollTrayEdit:LicenseChanged"),N.appContext.getModelRegistry("photo-models").then(function(t){for(f=0;f<x;f++)u=r.slice(i,h+i),a=u.join(","),i+=h,t.remoteBatchUpdate(a,n).then(function(e){if(e&&e.length>0)if(e.length===3&&e[2]){g=e[0].errors;for(l=0;l<g.length;l++)g[l].code===106&&o.photoRetry>0?(w.push(g[l].photoId),w=w.filter(function(e,t){return w.indexOf(e)===t})):c.push({id:g[l].photoId,code:g[l].code,api:e[0].api});y=e[1].errors;for(p=0;p<y.length;p++)y[p].code===106&&o.photoRetry>0?(w.push(y[p].photoId),w=w.filter(function(e,t){return w.indexOf(e)===t})):c.push({id:y[p].photoId,code:y[p].code,api:e[1].api});b=e[2].errors;for(d=0;d<b.length;d++)b[d].code===106&&o.photoRetry>0?(w.push(b[d].photoId),w=w.filter(function(e,t){return w.indexOf(e)===t})):c.push({id:b[d].photoId,code:b[d].code,api:e[2].api})}else if(e.length===2&&e[1]){g=e[0].errors;for(l=0;l<g.length;l++)g[l].code===106&&o.photoRetry>0?(w.push(g[l].photoId),w=w.filter(function(e,t){return w.indexOf(e)===t})):c.push({id:g[l].photoId,code:g[l].code,api:e[0].api});y=e[1].errors;for(p=0;p<y.length;p++)y[p].code===106&&o.photoRetry>0?(w.push(y[p].photoId),w=w.filter(function(e,t){return w.indexOf(e)===t})):c.push({id:y[p].photoId,code:y[p].code,api:e[1].api})}else if(e[0]){g=e[0].errors;for(l=0;l<g.length;l++)g[l].code===106&&o.photoRetry>0?(w.push(g[l].photoId),w=w.filter(function(e,t){return w.indexOf(e)===t})):c.push({id:g[l].photoId,code:g[l].code,api:e[0].api})}m--;if(!m){if(w.length!==0&&o.photoRetry>0)return s.photoUpdate=!1,o.photoRetry--,N.savePhotosUpdates(w);n={},s.photoUpdate=!0,N.checkIfAPICallsAreDone()}},function(t){e.Flog.warn(N.name,"editing photo failed",t),m--,E=t.photoIds.split(",");if(o.photoRetry>0&&(t.clientTimeout||t.message==="XHR error"))w=w.concat(E),w=w.filter(function(e,t){return w.indexOf(e)===t});else{S=t.returnApi;for(v=0;v<E.length;v++)c.push({id:E[l].photoId,code:"",api:S})}if(!m){if(w.length!==0&&o.photoRetry>0)return s.photoUpdate=!1,o.photoRetry--,N.savePhotosUpdates(w);n={},s.photoUpdate=!0,N.checkIfAPICallsAreDone()}}).catch(function(e){c.push({id:"",code:e.code,api:"photoUpdate"}),s.photoUpdate=!0,N.checkIfAPICallsAreDone()})})},savePhotosPermissions:function(t){var n,i=0,u,a,f,l,h,p,d,v=[],m=[],g,y,b,w=50,E=this;n=t||this.get("selectedPhotosIDs"),b=n.length,y=Math.ceil(b/w),d=y,e.rapidTracker.beacon(E.name,"camerarollTrayEdit:PermissionsChanged"),E.appContext.getModelRegistry("photo-privacy-models").then(function(t){for(l=0;l<y;l++)u=n.slice(i,w+i),a=u.join(","),i+=w,f=e.clone(r.privacy),t.remoteBatchUpdate(a,r).then(function(t){g=t.errors;if(g&&g.length>0){e.Flog.warn(E.name,"editing permissions failed",t);for(h=0;h<g.length;h++)g[h].code===106&&o.permissionsRetry>0?(v.push(g[h].photoId),v=v.filter(function(e,t){return v.indexOf(e)===t})):c
.push({id:g[h].photoId,code:g[h].code,api:"photoPermissionsUpdate"})}else"privacy"in r&&e.fire("cameraRollEditDialog:selectionPrivacyChanged",{newPrivacyValues:f,privacyChangedIDs:t.photoIdsSent.split(",")});d--;if(!d){if(v.length!==0&&o.permissionsRetry>0)return s.permissionsUpdate=!1,o.permissionsRetry--,E.savePhotosPermissions(v);r={},s.permissionsUpdate=!0,E.checkIfAPICallsAreDone()}},function(t){e.Flog.warn(E.name,"editing permissions failed",t),d--,m=t.photoIds.split(",");if(o.permissionsRetry>0&&(t.clientTimeout||t.message==="XHR error"))v=v.concat(m),v=v.filter(function(e,t){return v.indexOf(e)===t});else for(p=0;p<m.length;p++)c.push({id:m[p],code:"noRetry",api:"photoPermissionsUpdate"});if(!d){if(v.length!==0&&o.permissionsRetry>0)return s.permissionsUpdate=!1,o.permissionsRetry--,E.savePhotosPermissions(v);r={},s.permissionsUpdate=!0,E.checkIfAPICallsAreDone()}}).catch(function(e){c.push({id:"",code:e.code,api:"photoPermissionsUpdate"}),s.permissionsUpdate=!0,E.checkIfAPICallsAreDone()})})},saveDates:function(t,n){var r=this,u,a=0,f,l,h,p,v,m,g,b,w=[],E=[],S=[];s.datesUpdate=!1,u=n||this.get("selectedPhotosIDs"),g=u.length,m=Math.ceil(g/d),b=m,t&&(t[1]&&(i.takenDate=t[1]),t[2]&&(i.postedDate=t[2]),t[3]>=0&&t[3]<=10&&(i.takenGranularity=t[3]),t.length>=5&&t[4]&&(i.dateTakenPartial=t[4],i.takenDate=undefined),t.length>=6&&t[5]&&(i.datePostedPartial=t[5],i.postedDate=undefined)),e.rapidTracker.beacon(r.name,"camerarollTrayEdit:datesChanged",{count:g}),r.appContext.getModelRegistry("photo-stats-models").then(function(t){for(h=0;h<m;h++)f=u.slice(a,d+a),l=f.join(","),a+=d,t.remoteBatchUpdate(l,i).then(function(t){b--,S=S.concat(l);if(t&&t.length>0)for(p=0;p<t.length;p++)S.slice(S.indexOf(t[p].photoId),1),t[p].code===106&&o.datesRetry>0?(w.push(t[p].photoId),w=w.filter(function(e,t){return w.indexOf(e)===t})):(c.push({id:t[p].photoId,code:t[p].code,api:"dates"}),c=c.filter(function(e,t){return c.indexOf(e)===t}));y=!0,e.fire("cameraRollEditDialog:datesChanged",{newDates:i,photoIdsUpdated:S[0].split(",")});if(!b){if(w.length!==0&&o.datesRetry>0)return s.datesUpdate=!1,o.datesRetry--,r.saveDates(null,w);i={},s.datesUpdate=!0,r.checkIfAPICallsAreDone()}},function(e){var t=!1,n=!1;b--,e&&e.photoIds&&e.photoIds.length&&(E=e.photoIds.split(","));if(o.datesRetry>0&&(e.clientTimeout||e.message==="XHR error"))w=w.concat(E),w=w.filter(function(e,t){return w.indexOf(e)===t});else if(e.message==="Invalid date_posted")t=!0;else if(e.message==="Invalid Date Taken")n=!0;else for(v=0;v<E.length;v++)c.push({id:E[v],code:"noRetry",api:"dates"});if(!b){if(w.length!==0&&o.datesRetry>0)return s.datesUpdate=!1,o.datesRetry--,r.saveDates(null,w);t&&c.push({id:"",code:4,api:"datePostedGreaterThanFlickr"}),n&&c.push({id:"",code:6,api:"dateTakenInvalid"}),i={},s.datesUpdate=!0,r.checkIfAPICallsAreDone()}}).catch(function(e){c.push({id:"",code:e.code,api:"dates"}),s.datesUpdate=!0,r.checkIfAPICallsAreDone()})},function(e){c.push({id:"",code:e.code,api:"dates"}),s.datesUpdate=!0,r.checkIfAPICallsAreDone()})},checkIfAPICallsAreDone:function(){var t=this,n=this.get("container"),r=this.get("selectedPhotosIDs").length,i=0;c.forEach(function(e){i+=e.photosFailed}),s.peopleAddition&&s.peopleRemoval&&s.permissionsUpdate&&s.photoUpdate&&s.tagAddition&&s.tagRemoval&&s.datesUpdate&&(n.ancestor(".cameraroll-edit-dialog").one(".foot").removeClass("balls"),s={tagAddition:!1,tagRemoval:!1,peopleAddition:!1,peopleRemoval:!1,photoUpdate:!1,permissionsUpdate:!1,datesUpdate:!0},o={tagsRetry:10,peopleRetry:10,photoRetry:10,permissionsRetry:10,datesRetry:10},g.close(),c.length>0&&t.consolidateErrors(),e.fire("cameraRollEditDialog:apiCallsDone",{datesChanged:y,numberOfPhotosUpdated:this.noChanges?0:r-i}),y=!1)},consolidateErrors:function(){var e=this,t,n,r=[],i=[],s=[],o=[],u=[],a=[],f=[],l=[],h,p,d,v,m,g,y,b;b=e.intlMessage({intlName:"cameraroll.CONSOLIDATED_ERROR_MESSAGE"})+"<ul class='consolidated-error-list'>";for(t=0;t<c.length;t++)c[t].api==="setMeta"?r.push(c[t]):c[t].api==="setSafety"?i.push(c[t]):c[t].api==="setLicense"?s.push(c[t]):c[t].api==="photoPermissionsUpdate"?o.push(c[t]):c[t].api==="invalidDates"?l.push(c[t]):c[t].api==="dates"?f.push(c[t]):c[t].api==="datePostedGreaterThanFlickr"?b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.DATE_UPLOADED_GREATER_THAN_FLICKR_JOIN"})+"</li>":c[t].api==="dateTakenInvalid"?b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"common.INVALID_DATE_TAKEN"})+"</li>":c[t].api==="peopleTagsAdd"?a.push(c[t]):c[t].api==="peopleUserError"?b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.UNABLE_TO_ADD_USERS_TO_ALL_PHOTOS",count:c[t].usersFailed})+"</li>":c[t].api==="peoplePhotoError"?b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.UNABLE_TO_ADD_PHOTOS_TO_ALL_USERS",count:c[t].photosFailed})+"</li>":c[t].api==="unableToAddPersonToPhoto"?b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.UNABLE_TO_ADD_USERS_TO_PHOTO",count:c[t].usersFailed})+"</li>":c[t].api==="maxTagsInPhoto"?b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.UNABLE_TO_ADD_TAGS_TO_PHOTOS",count:c[t].photosFailed})+"</li>":c[t].api==="tagsAdd"?u.push(c[t]):c[t].api==="photoUpdate"&&a.push(c[t]);r.length>0&&(h="<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.ERROR_TITLE_PHOTOS",count:r.length})+"</li>",b+=h),i.length>0&&(p="<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.ERROR_SAFETY_PHOTOS",count:i.length})+"</li>",b+=p),s.length>0&&(d="<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.ERROR_LICENSE_PHOTOS",count:s.length})+"</li>",b+=d),o.length>0&&(v="<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.ERROR_PERMISSIONS_PHOTOS",count:o.length})+"</li>",b+=v),u.length>0&&(m="<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.ERROR_TAGS_PHOTOS",count:u.length})+"</li>",b+=m),a.length>0&&(g="<li class='error-list-item'>"+e.intlMessage
({intlName:"cameraroll.ERROR_PEOPLE_PHOTOS",count:a.length})+"</li>",b+=g),f.length>0&&(y="<li class='error-list-item'>"+e.intlMessage({intlName:"cameraroll.ERROR_DATES_PHOTOS",count:f.length})+"</li>",b+=y);if(l.length>0)for(n=0;n<l.length;n++)l[n].code===e.intlMessage({intlName:"common.INVALID_DATE_TAKEN"})&&(b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"common.INVALID_DATE_TAKEN"})+"</li>"),l[n].code===e.intlMessage({intlName:"common.INVALID_DATE_UPLOADED"})&&(b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"common.INVALID_DATE_UPLOADED"})+"</li>"),l[n].code===e.intlMessage({intlName:"common.FUTURE_DATE_UPLOADED"})&&(b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"common.FUTURE_DATE_UPLOADED"})+"</li>"),l[n].code===e.intlMessage({intlName:"common.INVALID_DATE"})&&(b=b+"<li class='error-list-item'>"+e.intlMessage({intlName:"common.INVALID_DATE"})+"</li>");b+="</ul>",c=[],e.onError(b)},saveClicked:function(t){var i,o,c=this.get("container"),h=this.get("originalFieldValues"),p=!0;i=c.one(".edit-photos-title").get("value"),o=c.one(".edit-photos-description").get("value");if(h.title&&i!==h.title||!h.title&&i)n.title=i,e.rapidTracker.beacon(this.name,"camerarollTrayEdit:TitleChange"),p=!1;if(h.description&&o!==h.description||!h.description&&o)n.description=o,e.rapidTracker.beacon(this.name,"camerarollTrayEdit:DescriptionChange"),p=!1;u.length||a.length||c.one(".edit-photos-tags").get("value")!==""?(this.saveTags(),p=!1):(s.tagAddition=!0,s.tagRemoval=!0),f.length||l.length?(this.savePeople(),p=!1):(s.peopleAddition=!0,s.peopleRemoval=!0),Object.getOwnPropertyNames(n).length?(this.savePhotosUpdates(),p=!1):s.photoUpdate=!0,Object.getOwnPropertyNames(r).length?(this.savePhotosPermissions(),p=!1):s.permissionsUpdate=!0,c.ancestor(".cameraroll-edit-dialog").one(".foot").addClass("balls"),g=t,this.noChanges=p},cancelClicked:function(){n={},r={},i={},u=[],a=[],f=[],l=[],c=[],s={tagAddition:!1,tagRemoval:!1,peopleAddition:!1,peopleRemoval:!1,photoUpdate:!1,permissionsUpdate:!1,datesUpdate:!0},o={tagsRetry:10,peopleRetry:10,photoRetry:10,permissionsRetry:10,datesRetry:10}},onSubviewEvent:function(t,n){var r,i,o,u,a;return n&&(n[0]==="camerarollEditDialog:datesEmpty"?(this.saveClicked(this.parentModal),this.checkIfAPICallsAreDone()):n[0]==="camerarollEditDialog:datesToBeUpdated"?(this.saveClicked(this.parentModal),this.saveDates(n),this.checkIfAPICallsAreDone()):n[0]==="camerarollEditDialog:datesInvalid"?(s.datesUpdate=!0,n[1]==="invalidDateTaken"?r=this.intlMessage({intlName:"common.INVALID_DATE_TAKEN_VALUE"}):n[1]==="invalidDatePosted"?r=this.intlMessage({intlName:"common.INVALID_DATE_UPLOADED_VALUE"}):n[1]==="datePostedFuture"?r=this.intlMessage({intlName:"common.FUTURE_DATE_UPLOADED"}):n[1]==="dateTakenFuture"?r=this.intlMessage({intlName:"common.FUTURE_DATE_TAKEN"}):n[1]==="invalidDatePostedBeforeAccount"?r=this.intlMessage({intlName:"common.DATE_UPLOADED_BEFORE_ACCOUNT",intlDate:n[2]}):r=this.intlMessage({intlName:"common.INVALID_DATE_VALUE"}),this.onValidationError(r)):n[0]==="camerarollEditDialogPeople:personAdded"?(u=n[1],i=this.get("originalFieldValues").people,e.Array.find(i,function(e){return e.nsid===u})?(e.Array.find(l,function(e,t){if(e===u)return a=t,!0}),l.splice(a,1)):f.push(u)):n[0]==="camerarollEditDialogPeople:personRemoved"&&(u=n[1],i=this.get("originalFieldValues").people,o=e.Array.find(i,function(e){return e.nsid===u}),o?l.push(u):f.splice(f.indexOf(u),1))),!1},onError:function(t){var n=this,r;r=new e.Views.FluidModal({appContext:this.appContext,title:n.intlMessage({intlName:"common.ERROR"}),message:t,actionButtonLabel:n.intlMessage({intlName:"common.OK"}),showCancelButton:!1}),r.show()},onValidationError:function(t){var n=e.Node.create(this.templates("validation-error")({message:t})),r=e.Node.create("<div></div>"),i=this.get("container"),s=20,o=i.get("clientWidth")+s,u=i.get("clientHeight")+s,a=500,f=100,l=o/2-(a+s)/2,c=u/2-(f+s)/2;n.setStyle("width",a),n.setStyle("height",f),n.setStyle("left",l),n.setStyle("top",c),r.setStyle("left",0),r.setStyle("top",0),r.setStyle("width","100%"),r.setStyle("height","100%"),r.addClass("validation-modal"),i.append(r),r.append(n),r.on("click",function(){r.remove(!0)})}},{ATTRS:{selectedPhotosIDs:{value:""}}})},"@VERSION@",{requires:["flog","flickr-view","flickr-promise","fluid-css","fluid-balls-css","flutil","url-helper","hermes-template-cameraroll-edit-dialog-body","hermes-template-validation-error","validation-error-css"],optional:["cameraroll-edit-dialog-people-view","cameraroll-edit-dialog-dates-view"],langBundles:["common","settings","cameraroll","errors"]});
YUI.add("hermes-lang-errors",function(e,t){e.Intl.add("hermes/errors","en-US",{UNAUTHORIZED_ACCESS:["Unauthorized Access"],YOU_ARE_NOT_AUTHORIZED:["You have attempted to access a page for which you are not authorized."],AUTO_REDIRECT_IN_10_SECONDS:["This page will automatically redirect to the Flickr home page in 10 seconds,"],OR_CLICK_LINK_FOR_HOME:["or click the following link to go straight to the <a href='/'>home page</a>."],ERROR:["Error"],ERROR_HAS_OCCURRED:["An error has occurred. Please try again."],ERROR_REPLACING:["An error has occurred replacing the image. Please try again."],ERROR_SAVING:["An error has occurred saving the image. Please try again."],DOWNLOAD_EXPIRED:["Download expired"],DOWNLOAD_NO_LONGER_AVAILABLE:["Your download is no longer available."]})},"@VERSION@",{requires:["intl"]});
YUI.add("hermes-template-cameraroll-edit-dialog",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a=n.helperMissing,f=this.escapeExpression;return s+="<div class='edit-selected-photos'>\n	<i class=\"edit-selected-photos-icon\"></i>\n	<span>",u={hash:{intlName:"cameraroll.EDIT"},data:i},s+=f((o=n.intlHTMLMessage||t.intlHTMLMessage,o?o.call(t,u):a.call(t,"intlHTMLMessage",u)))+"</span>\n</div>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/cameraroll-edit-dialog",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("cameraroll-edit-dialog-view",function(e){var t=300;e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this.maxItemsToEdit=e.maxItemsToEdit,this},loadState:function(){return e.Promise.resolve()},buildContainer:function(){var e;return e=this.templates("cameraroll-edit-dialog")({}),this.setContainerHTML(e),this},editSelectedPhotos:function(n){n.preventDefault();var r=this,i,s,o=e.CameraRollSelectionManager.getSelection(),u,a,f,l=!1,c;if(this.get("dialogRequested"))return;if(o.length){a=o.length;if(a>this.maxItemsToEdit){this.fire("subviewViewEvent","cameraroll-too-many-items","edit",this.maxItemsToEdit);return}u=o.map(function(t){return e.CameraRollViewModel.getPhotoIDByGUID(t)}),e.Promise.all(u).then(function(n){var i;return f=e.Array.dedupe(n),i=r.appContext.callAPI("flickr.cameraroll.getPhotosMeta",{photo_ids:f.join(","),properties:["name","title","description","is_public","is_family","is_friend","perm_comment","perm_addmeta","adultness","license","tags","people","date_taken","date_create","date_taken_granularity"].join(",")}).then(null,function(t){var n=!1;e.Flog.error("getPhotosMeta failed",t),s&&s.close(),n=t&&t.code===99;var i=new e.Views.FluidModal({appContext:r.appContext,title:r.intlMessage({intlName:"common.OOPS"}),message:n?r.intlMessage({intlName:"cameraroll.ERROR_SIGNED_OUT"}):r.intlMessage({intlName:"cameraroll.ERROR_BEFORE_EDITING_OUT"}),actionButtonLabel:r.intlMessage({intlName:"common.OK"}),showCancelButton:!1});n&&i.on("actionClick",function(){e.SigninHelper._redirectToSignin()}),setTimeout(function(){i.show()},100)}),c=setTimeout(function(){s=(new e.Views.FluidModal({appContext:r.appContext,title:r.intlMessage({intlName:"cameraroll.EDIT_PHOTOS",selectedCount:f.length}),htmlMessage:r.templates("flickr-balls")({}),showButtons:!1,classList:"cameraroll-edit-dialog-loading"})).show(),s.on("close",function(){r.set("dialogRequested",!1),l=!0})},t),i}).then(function(t){var n;clearTimeout(c);if(l)return;t.name&&(t.title=t.name),n=new e.Views["cameraroll-edit-dialog-body-view"]({appContext:r.appContext,selectedPhotosIDs:f,commonData:t,isLoading:!1}),s&&s.close(),i=(new e.Views.FluidModal({appContext:r.appContext,title:r.intlMessage({intlName:"cameraroll.EDIT_PHOTOS",selectedCount:f.length}),subview:n,actionButtonLabel:r.intlMessage({intlName:"common.SAVE"}),cancelButtonLabel:r.intlMessage({intlName:"common.CANCEL"}),classList:"cameraroll-edit-dialog",dismissOnActionClick:!1})).show(),r.set("dialogRequested",!1),i.on("actionClick",function(){i.get("container").one(".close-x").hide(),n.fire("doSave",i),e.rapidTracker.beacon(this.name,"camerarollTrayEdit:saveClicked",{count:a})}),i.on("cancelClick",function(){this.get("subview").cancelClicked()})}),this.set("dialogRequested",!0),e.rapidTracker.beacon(this.name,"editSelectedCameraRollImages")}},activate:function(){return this.registerEventHandler(this.get("container").one(".edit-selected-photos").on("click",this.editSelectedPhotos,this)),this}},{ATTRS:{dialogRequested:{validator:function(t){return e.AttributeHelpers.validateBoolean(t)},setter:function(t){return e.AttributeHelpers.coerceBoolean(t)},defaultValue:!1}}})},"@VERSION@",{requires:["flickr-view","flickr-promise","fluid-modal-view","dropdown","cameraroll-edit-dialog-body-view","hermes-template-cameraroll-edit-dialog","hermes-template-flickr-balls","cameraroll-edit-dialog-css","cameraroll-selection-manager","cameraroll-view-model"],langBundles:["common","cameraroll"],optional:[]});
YUI.add("hermes-template-cameraroll-tray-privacy-button",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a=n.helperMissing,f=this.escapeExpression;return s+='<div class="edit-privacy">\n	<i class="edit-privacy-icon"></i>\n	<span>',u={hash:{intlName:"cameraroll.PRIVACY"},data:i},s+=f((o=n.intlHTMLMessage||t.intlHTMLMessage,o?o.call(t,u):a.call(t,"intlHTMLMessage",u)))+"</span>\n</div>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/cameraroll-tray-privacy-button",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-cameraroll-privacy-dialog",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function h(e,t){return'checked=""'}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a,f=this,l=n.helperMissing,c=this.escapeExpression;s+='\n<ul>\n	<li>\n		<div class="radio">\n			<input type="radio" id="radio-small-1" name="radio-small" value="public" ',o=n["if"].call(t,t["public"],{hash:{},inverse:f.noop,fn:f.program(1,h,i),data:i});if(o||o===0)s+=o;s+='>\n			<label for="radio-small-1">\n			<div></div>\n			<span>',a={hash:{intlName:"settings.PUBLIC"},data:i},s+=c((o=n.intlMessage||t.intlMessage,o?o.call(t,a):l.call(t,"intlMessage",a)))+'</span>\n			</label>\n		</div>\n	</li>\n\n	<li>\n		<div class="radio">\n			<input type="radio" id="radio-small-2" name="radio-small" value="private" ',u=n["if"].call(t,t["private"],{hash:{},inverse:f.noop,fn:f.program(1,h,i),data:i});if(u||u===0)s+=u;s+='>\n			<label for="radio-small-2">\n			<div></div>\n			<span>',a={hash:{intlName:"settings.PRIVATE"},data:i},s+=c((o=n.intlMessage||t.intlMessage,o?o.call(t,a):l.call(t,"intlMessage",a)))+'</span>\n			</label>\n		</div>\n	</li>\n\n	<li>\n		<div class="radio">\n			<input type="radio" id="radio-small-3" name="radio-small" value="friends" ',u=n["if"].call(t,t.friends,{hash:{},inverse:f.noop,fn:f.program(1,h,i),data:i});if(u||u===0)s+=u;s+='>\n			<label for="radio-small-3">\n			<div></div>\n			<span>',a={hash:{intlName:"settings.FRIENDS"},data:i},s+=c((o=n.intlMessage||t.intlMessage,o?o.call(t,a):l.call(t,"intlMessage",a)))+'</span>\n			</label>\n		</div>\n	</li>\n\n	<li>\n		<div class="radio">\n			<input type="radio" id="radio-small-4" name="radio-small" value="family" ',u=n["if"].call(t,t.family,{hash:{},inverse:f.noop,fn:f.program(1,h,i),data:i});if(u||u===0)s+=u;s+='>\n			<label for="radio-small-4">\n			<div></div>\n			<span>',a={hash:{intlName:"settings.FAMILY"},data:i},s+=c((o=n.intlMessage||t.intlMessage,o?o.call(t,a):l.call(t,"intlMessage",a)))+'</span>\n			</label>\n		</div>\n	</li>\n\n	<li>\n		<div class="radio">\n			<input type="radio" id="radio-small-5" name="radio-small" value="friendsfamily" ',u=n["if"].call(t,t.friendsfamily,{hash:{},inverse:f.noop,fn:f.program(1,h,i),data:i});if(u||u===0)s+=u;return s+='>\n			<label for="radio-small-5">\n			<div></div>\n			<span>',a={hash:{intlName:"settings.FRIENDS_AND_FAMILY"},data:i},s+=c((o=n.intlMessage||t.intlMessage,o?o.call(t,a):l.call(t,"intlMessage",a)))+"</span>\n			</label>\n		</div>\n	</li>\n</ul>\n",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/cameraroll-privacy-dialog",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("cameraroll-tray-privacy-button-view",function(e,t){var n=500;e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this.maxItemsToEdit=e.maxItemsToEdit,this},loadState:function(){return e.Promise.resolve()},buildContainer:function(){var e;return e=this.templates("cameraroll-tray-privacy-button")({}),this.setContainerHTML(e),this},activate:function(){return this.registerEventHandler(this.get("container").one(".edit-privacy").on("click",this.editPrivacy,this)),this},editPrivacy:function(r){var i=this,s,o=e.CameraRollSelectionManager.getSelection(),u,a,f=!1,l,c;r.preventDefault(),o.length>n?(l=(new e.Views.FluidModal({appContext:this.appContext,title:this.intlMessage({intlName:"common.ZOINKS"}),message:this.intlMessage({intlName:"cameraroll.TOO_MANY_EDITS",count:n}),cancelButtonLabel:this.intlMessage({intlName:"common.OK"}),showActionButton:!1})).show(),l.on("actionClick",function(){l.destroy()})):o.length&&(u=o.map(function(t){return e.CameraRollViewModel.getPhotoIDByGUID(t)}),e.Promise.all(u).then(function(n){return c=e.Array.dedupe(n),e.rapidTracker.beacon(t,"cameraRollChangePrivacyClick",{count:c.length}),i.appContext.callAPI("flickr.cameraroll.getPhotosMeta",{photo_ids:c.join(","),properties:["is_public","is_family","is_friend"].join(",")}).then(function(n){n.isPublic?f={"public":!0}:n.isFriend&&!n.isFamily?f={friends:!0}:!n.isFriend&&n.isFamily?f={family:!0}:n.isFriend&&n.isFamily?f={friendsfamily:!0}:n.isPublic===0&&n.isFriend===0&&n.isFamily===0&&(f={"private":!0}),s=new e.Views.FluidModal({appContext:i.appContext,title:i.intlMessage({intlName:"cameraroll.CHANGE_PRIVACY_PHOTOS",count:c.length}),message:i.templates("cameraroll-privacy-dialog")(f),actionButtonLabel:i.intlMessage({intlName:"common.CHANGE"}),cancelButtonLabel:i.intlMessage({intlName:"common.CANCEL"}),actionButtonDisabled:f?!1:!0,classList:"cameraroll-privacy-change-dialog",dismissOnActionClick:!1,width:400}),s.show(),s.registerEventHandler(s.on("activated",function(){s.reposition(),s.registerEventHandler(s.get("container").all("input").on("change",function(){s.enableActionButton()}))})),s.registerEventHandler(s.on("actionClick",function(n){var r=n&&n.target&&n.target.get?n.target.get("container"):null,o;r&&(o=r.one('[name="radio-small"]:checked'),o&&(a=o.get("value"))),s.close(),a&&(e.rapidTracker.beacon(t,"cameraRollChangePrivacyConfirmationClick",{count:c.length}),i.showPrivacyDialog(i.mapPrivacy(a)))}))},function(t){var n=!1;e.Flog.error("getPhotosMeta failed",t),n=t&&t.code===99;var r=new e.Views.FluidModal({appContext:i.appContext,title:i.intlMessage({intlName:"common.OOPS"}),message:n?i.intlMessage({intlName:"cameraroll.ERROR_SIGNED_OUT"}):i.intlMessage({intlName:"cameraroll.PRIVACY_ERROR"}),actionButtonLabel:i.intlMessage({intlName:"common.OK"}),showCancelButton:!1});n&&r.on("actionClick",function(){e.SigninHelper._redirectToSignin()}),r.show()})}))},savePrivacyForPhotoIds:function(t,n){var r=50,i=t.length,s,o=0,u,a=[],f=this;return i%r===0?s=i/r:s=Math.floor(i/r)+1,u=function(){var i=t.slice(o,r+o),l=i.join(",");return o+=r,s--,f.appContext.getModelRegistry("photo-privacy-models").then(function(t){return t.remoteBatchUpdate(l,{privacy:n}).then(function(t){t&&t.errors&&t.errors.forEach(function(e){i.splice(i.indexOf(e.photoId,1)),a.indexOf(e.photoId)===-1&&a.push(e.photoId)}),i.length>0&&e.fire("cameraRollEditDialog:selectionPrivacyChanged",{newPrivacyValues:n,privacyChangedIDs:i})},function(){i.forEach(function(e){i.forEach(function(e){a.indexOf(e)===-1&&a.push(e)})})}).then(function(){return s>0?u():{failedPhotoIds:a}})})},s>0?u():e.Promise.resolve({failedPhotoIds:[]})},savePrivacy:function(t,n){var r=this,i=t.map(function(t){return e.CameraRollViewModel.getPhotoIDByGUID(t)});return e.Promise.all(i).then(function(t){return r.savePrivacyForPhotoIds(t,n).then(function(t){if(t&&t.failedPhotoIds&&t.failedPhotoIds.length)return e.Flog.log(r.name,"retry failed IDs",t.failedPhotoIds),r.savePrivacyForPhotoIds(t.failedPhotoIds,n)}).then(function(t){if(t&&t.failedPhotoIds&&t.failedPhotoIds.length)return e.Flog.log(r.name,"retry failed IDs",t.failedPhotoIds),r.savePrivacyForPhotoIds(t.failedPhotoIds,n)})}).then(function(t){e.fire("cameraRollTray:selectionPrivacyChangeComplete",{newPrivacyValues:n,privacyChangedIDs:e.CameraRollSelectionManager.getSelection()}),e.Flog.log(r.name,"savePrivacy resolved",t)},function(t){e.Flog.log(r.name,"savePrivacy rejected",t)})},onError:function(t){var n=this,r;r=new e.Views.FluidModal({appContext:this.appContext,title:n.intlMessage({intlName:"common.ERROR"}),message:t,actionButtonLabel:n.intlMessage({intlName:"common.OK"}),showCancelButton:!1}),r.show()},mapPrivacy:function(e){var t,n,r,i,s;t=[["public",["isPublic"]],["friendsfamily",["isVisibleByFriends","isVisibleByFamily"]],["friends",["isVisibleByFriends"]],["family",["isVisibleByFamily"]],["private",[]]];if(typeof e=="object"){for(n=0,r=t.length;n<r;n++){i=t[n];if(!i[1].length||i[1].every(function(t){return!!e[t]}))return i[0]}return null}s={};for(n=0,r=t.length;n<r;n++)i=t[n],i[1].forEach(function(t){s[t]=i[0]===e?!0:s[t]||!1});return s},showPrivacyDialog:function(n){var r,i=this,s=e.CameraRollSelectionManager.getSelection(),o=s.length,u,a;n.isPublic?(u=i.intlMessage({intlName:"cameraroll.CHANGE_PRIVACY_PHOTOS_PUBLIC",count:o}),a=i.intlMessage({intlName:"cameraroll.CHANGE_PRIVACY_MESSAGE_PUBLIC",count:o})):(u=i.intlMessage({intlName:"cameraroll.CHANGE_PRIVACY_PHOTOS",count:o}),a=i.intlMessage({intlName:"cameraroll.CHANGE_PRIVACY_MESSAGE",count:o})),r=new e.Views.FluidModal({appContext:this.appContext,title:u,message:a,actionButtonLabel:i.intlMessage({intlName:"common.OK"}),cancelButtonLabel:i.intlMessage({intlName:"common.CANCEL"}),classList:"cameraroll-privacy-dialog",dismissOnActionClick:!1}),r.on("actionClick",function(){e.rapidTracker.beacon(t,"cameraRollChangePrivacySuperConfirmationClick")
,r.get("container").one(".foot").addClass("loading").append(this.templates("flickr-balls")({})),r.get("container").one(".close-x").hide(),i.savePrivacy(s,n).then(function(){r.close()})}),r.show()}})},"@VERSION@",{requires:["flog","flickr-view","flickr-promise","hermes-template-cameraroll-tray-privacy-button","hermes-template-cameraroll-privacy-dialog","cameraroll-tray-css","cameraroll-selection-manager","cameraroll-view-model","fluid-droparound-view","fluid-modal-view","hermes-template-flickr-balls","fluid-balls-css","privacy-helper"],langBundles:["cameraroll","common","settings"],optional:[]});
YUI.add("hermes-template-cameraroll-tray-delete-button",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a=n.helperMissing,f=this.escapeExpression;return s+='<div class="delete-selected-photos">\n	<i class="delete-selected-photos-icon"></i>\n	<span>',u={hash:{intlName:"cameraroll.DELETE"},data:i},s+=f((o=n.intlHTMLMessage||t.intlHTMLMessage,o?o.call(t,u):a.call(t,"intlHTMLMessage",u)))+"</span>\n</div>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/cameraroll-tray-delete-button",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("cameraroll-tray-delete-button-view",function(e,t){e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return this.get("container").get("innerHTML")===""&&this.setContainerHTML(""),this.maxItemsToEdit=e.maxItemsToEdit,this},loadState:function(){return e.Promise.resolve()},buildContainer:function(){var e;return e=this.templates("cameraroll-tray-delete-button")({}),this.setContainerHTML(e),this},activate:function(){return this.registerEventHandler(this.get("container").one(".delete-selected-photos").on("click",this.showDeleteDialog.bind(this))),this},showDeleteDialog:function(n){n.preventDefault();var r,i=this,s=e.CameraRollSelectionManager.getSelection(),o=s.length,u,a,f,l;f=s.map(function(t){return e.CameraRollViewModel.getPhotoIDByGUID(t)}),e.Promise.all(f).then(function(n){l=e.Array.dedupe(n),o=l.length,e.rapidTracker.beacon(t,"cameraRollDeletePhotosClick",{count:o}),u=i.intlMessage({intlName:"cameraroll.DELETE_PHOTOS",selectedCount:o}),a=i.intlMessage({intlName:"cameraroll.DELETE_MESSAGE",selectedCount:o}),r=new e.Views.FluidModal({appContext:this.appContext,title:u,message:a,actionButtonLabel:i.intlMessage({intlName:"common.DELETE"}),cancelButtonLabel:i.intlMessage({intlName:"common.CANCEL"}),actionButtonIsDangerous:!0,classList:"cameraroll-delete-dialog",dismissOnActionClick:!1}),r.on("actionClick",function(){r.get("container").one(".close-x").hide(),r.get("container").one(".foot").hasClass("loading")||r.get("container").one(".foot").addClass("loading").append(this.templates("flickr-balls")({})),e.rapidTracker.beacon(t,"deleteConfirmationClick",{count:o}),i.handleDeleteFromCameraRollConfirm(s).then(function(t){var n,s;t.photoIDsSuccessfullyDeleted.length&&(n=e.CameraRollViewModel.getValue("viewerProfileModel"),n&&(s=n.getValue("photoCount"),n.setValue("photoCount",s-t.photoIDsSuccessfullyDeleted.length))),i.appContext.getModelRegistry("photostream-models").then(function(e){e.attributeSearch({normalizedId:i.appContext.getViewer().nsid},!0).forEach(function(t){e.remove(t)})}),r.close(),e.fire("cameraRollSelectionTray:selectionDeleted",t)})}),r.show()})},deletePhotosByID:function(t){var n=this,r=e.CameraRollSelectionManager,i=e.config.flickr.api.max_concurrent_photo_deletions,s,o=[],u,a,f,l;s=Math.ceil(t.length/i);for(l=0;l<s;l++)a=l*i,f=a+i,u=function(){var i=t.slice(a,f);return e.RetryablePromise(function(){return n.appContext.callAPI("flickr.photos.delete",{photo_ids:i.join(",")}).then(function(t){var n=[],s,o,u,a,f;for(u=0,f=i.length;u<f;u++){s=i[u],o=e.CameraRollViewModel.getGUIDsByPhotoID(s);for(a=0;a<o.length;a++)n.push(r.deselect(o[a]))}return r.update(n),{photoIDsSuccessfullyDeleted:i,photoIDsNotDeleted:[]}},function(e){return{photoIDsSuccessfullyDeleted:[],photoIDsNotDeleted:i}}).catch(function(t){e.Flog.error("Error in the deletion success handler",t)})},3)}(),o.push(u);return e.Promise.all(o)},handleDeleteFromCameraRollConfirm:function(t){var n=this,r;return e.fire("cameraRollSelectionTray:selectionDeletionConfirmed"),r=t.map(function(t){return e.CameraRollViewModel.getPhotoIDByGUID(t)}),e.Promise.all(r).then(function(e){return n.deletePhotosByID(e).then(function(e){var t=[],r=[];return e.forEach(function(e){t=t.concat(e.photoIDsSuccessfullyDeleted),r=r.concat(e.photoIDsNotDeleted)}),t.forEach(function(e){n.appContext.getModelRegistry("photo-sets-models",e).then(function(e){e.removeAll()})}),n.appContext.getModelRegistry("sets-models").then(function(e){e.exists(n.appContext.getViewer().nsid)&&e.remove(n.appContext.getViewer().nsid)}),{photoIDsSuccessfullyDeleted:t,photoIDsNotDeleted:r}})}).catch(function(n){e.fire("cameraRollSelectionTray:selectionDeleted",{photoIDsSuccessfullyDeleted:[],photoIDsNotDeleted:t})})},onError:function(t){var n=this,r;e.fire("cameraRollSelectionTray:selectionDeletionError"),r=new e.Views.FluidModal({appContext:this.appContext,title:n.intlMessage({intlName:"common.ERROR"}),message:t,actionButtonLabel:n.intlMessage({intlName:"common.OK"}),showCancelButton:!1}),r.show()}})},"@VERSION@",{requires:["flickr-view","flickr-promise","fluid-modal-view","hermes-template-cameraroll-tray-delete-button","cameraroll-tray-css","cameraroll-selection-manager","cameraroll-view-model","fluid-modal-view","hermes-template-flickr-balls","fluid-balls-css","photostream-models"],langBundles:["cameraroll","common"],optional:[]});
YUI.add("hermes-template-cameraroll-tray-album-button",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u,a=n.helperMissing,f=this.escapeExpression;return s+='<div class="album-selected-photos">\n	<i class="album-photos-icon"></i>\n	<span>',u={hash:{intlName:"photo-page-scrappy.ADD_TO_ALBUM"},data:i},s+=f((o=n.intlMessage||t.intlMessage,o?o.call(t,u):a.call(t,"intlMessage",u)))+"</span>\n</div>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/cameraroll-tray-album-button",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-album-selection",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u="function",a=this.escapeExpression;return s+='<div class="album-selection">\n	<h2 class="album-selection-heading">',(o=n.titleSelect)?o=o.call(t,{hash:{},data:i}):(o=t.titleSelect,o=typeof o===u?o.apply(t):o),s+=a(o)+'</h2>\n	<button class="ui-dialog-button ui-dialog-button-neutral ui-dialog-button-close hide-text"><span>&nbsp;</span></button>\n	<input type="text" placeholder="',(o=n.placeholderSearch)?o=o.call(t,{hash:{},data:i}):(o=t.placeholderSearch,o=typeof o===u?o.apply(t):o),s+=a(o)+"\" class='album-selection-search' />\n	<ol class='album-selection-list loading'>\n		<li>",(o=n.loadingText)?o=o.call(t,{hash:{},data:i}):(o=t.loadingText,o=typeof o===u?o.apply(t):o),s+=a(o)+'</li>\n	</ol>\n	<div class="album-selection-buttons">\n		<button class="ui-dialog-button ui-dialog-button-neutral ui-dialog-button-done album-selection-done"><span>',(o=n.buttonTextComplete)?o=o.call(t,{hash:{},data:i}):(o=t.buttonTextComplete,o=typeof o===u?o.apply(t):o),s+=a(o)+"</span></button>\n	</div>\n</div>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/album-selection",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-album-creation",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function l(e,t){var r="",i;return r+='\n			<div class="album-selection-list-item-icon-wrapper album-creation-list-item-create">\n				<img src="',(i=n.photoUrl)?i=i.call(e,{hash:{},data:t}):(i=e.photoUrl,i=typeof i===u?i.apply(e):i),r+=a(i)+'" class="album-creation-list-item-icon" />\n			</div>\n		',r}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u="function",a=this.escapeExpression,f=this;s+="<div class='album-creation'>\n	<h2 class=\"album-creation-heading\">",(o=n.titleCreate)?o=o.call(t,{hash:{},data:i}):(o=t.titleCreate,o=typeof o===u?o.apply(t):o),s+=a(o)+'</h2>\n	<button class="ui-dialog-button ui-dialog-button-neutral ui-dialog-button-close hide-text"><span>&nbsp;</span></button>\n	<div class="album-creation-content">\n		<span class="album-creation-list-item-icon-topper">&nbsp;</span>\n		',o=n.unless.call(t,t.multiplePhotos,{hash:{},inverse:f.noop,fn:f.program(1,l,i),data:i});if(o||o===0)s+=o;return s+='\n		<div class="album-creation-list-item-entry">\n			<input type="text" placeholder="',(o=n.placeholderTitle)?o=o.call(t,{hash:{},data:i}):(o=t.placeholderTitle,o=typeof o===u?o.apply(t):o),s+=a(o)+"\" class='album-creation-title' />\n			<textarea placeholder=\"",(o=n.placeholderDescription)?o=o.call(t,{hash:{},data:i}):(o=t.placeholderDescription,o=typeof o===u?o.apply(t):o),s+=a(o)+'" class="album-creation-description"></textarea>\n		</div>\n	</div>\n	<div class="album-creation-buttons">\n		<button class="ui-dialog-button ui-dialog-button-neutral ui-dialog-button-done album-selection-done album-creation-create" disabled><span>',(o=n.buttonTextCreate)?o=o.call(t,{hash:{},data:i}):(o=t.buttonTextCreate,o=typeof o===u?o.apply(t):o),s+=a(o)+'</span></button>\n		<button class="ui-dialog-button ui-dialog-button-neutral album-creation-cancel">\n			<span class="hide-text album-creation-cancel-back-icon">&nbsp;</span>\n			<span>',(o=n.buttonTextCancel)?o=o.call(t,{hash:{},data:i}):(o=t.buttonTextCancel,o=typeof o===u?o.apply(t):o),s+=a(o)+"</span>\n		</button>\n	</div>\n</div>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/album-creation",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-album-selection-list-item-stats",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{};var s="",o,u="function",a=this.escapeExpression;return s+='<span class="album-selection-list-item-stats">\n	',(o=n.photoCountDisplay)?o=o.call(t,{hash:{},data:i}):(o=t.photoCountDisplay,o=typeof o===u?o.apply(t):o),s+=a(o)+"\n</span>",s}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/album-selection-list-item-stats",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("hermes-template-album-selection-list-item",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function p(e,t){return"\n	pending belongs-to-album\n"}function d(e,t){var r="",i;return r+='\n		<img src="',(i=n.bestIconURL)?i=i.call(e,{hash:{},data:t}):(i=e.bestIconURL,i=typeof i===f?i.apply(e):i),r+=l(i)+'" class="album-selection-list-item-icon" />\n	',r}function v(e,t){return'\n		<img src="https://s.yimg.com/pw/images/buddyicon11_s.png" class="album-selection-list-item-icon" />\n	'}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),r=this.merge(r,e.partials),i=i||{};var s="",o,u,a,f="function",l=this.escapeExpression,c=this,h=n.helperMissing;s+='<li class="album-selection-list-item ',(o=n["class"])?o=o.call(t,{hash:{},data:i}):(o=t["class"],o=typeof o===f?o.apply(t):o),s+=l(o)+" ",o=n["if"].call(t,t.isPending,{hash:{},inverse:c.noop,fn:c.program(1,p,i),data:i});if(o||o===0)s+=o;s+='" data-album-id="',(o=n.id)?o=o.call(t,{hash:{},data:i}):(o=t.id,o=typeof o===f?o.apply(t):o),s+=l(o)+'" data-machine-title="',(o=n.machineTitle)?o=o.call(t,{hash:{},data:i}):(o=t.machineTitle,o=typeof o===f?o.apply(t):o),s+=l(o)+'">\n	<span class="album-selection-list-item-icon-topper">&nbsp;</span>\n	<div class="album-selection-list-item-icon-wrapper">\n	',o=n["if"].call(t,t.bestIconURL,{hash:{},inverse:c.program(5,v,i),fn:c.program(3,d,i),data:i});if(o||o===0)s+=o;s+='\n	</div>\n\n	<div class="album-selection-list-item-labels">\n		<span class="album-selection-list-item-title">',a={hash:{},data:i},s+=l((o=n.truncate||t.truncate,o?o.call(t,t.title,60,a):h.call(t,"truncate",t.title,60,a)))+"</span>\n		",u=c.invokePartial(r["album-selection-list-item-stats"],"album-selection-list-item-stats",t,n,r,i);if(u||u===0)s+=u;return s+='\n		<span class="isPending">',a={hash:{intlName:"groups.GROUP_ADD_PENDING"},data:i},s+=l((o=n.intlMessage||t.intlMessage,o?o.call(t,a):h.call(t,"intlMessage",a)))+"</span>\n	</div>\n\n</li>",s}),r={};e.Array.each(["album-selection-list-item-stats"],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/album-selection-list-item",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-album-selection-list-item-stats"]});
YUI.add("hermes-template-album-selection-list",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){function c(e,t){var r="",i;return r+='\n	<li class="album-selection-list-item album-selection-create-switch">\n		<span class="album-selection-list-item-icon-wrapper album-selection-list-item-create">&nbsp;</span>\n		<div class="album-selection-list-item-labels">\n			<span class="album-selection-list-item-title">',(i=n.buttonTextSwitchCreate)?i=i.call(e,{hash:{},data:t}):(i=e.buttonTextSwitchCreate,i=typeof i===u?i.apply(e):i),r+=a(i)+"</span>\n		</div>\n	</li>\n",r}function h(e,t){var r="",i;r+="\n	",i=n.each.call(e,e.albums,{hash:{},inverse:f.noop,fn:f.program(4,p,t),data:t});if(i||i===0)r+=i;return r+="\n",r}function p(e,t){var i="",s;i+="\n		",s=f.invokePartial(r["album-selection-list-item"],"album-selection-list-item",e,n,r,t);if(s||s===0)i+=s;return i+="\n	",i}function d(e,t){var r="",i;r+="\n	",i=n["if"].call(e,e.canCreateNew,{hash:{},inverse:f.program(9,m,t),fn:f.program(7,v,t),data:t});if(i||i===0)r+=i;return r+="\n",r}function v(e,t){return"\n	"}function m(e,t){var r="",i,s;return r+='\n		<div class="none">',s={hash:{},data:t},r+=a((i=n.renderTrustedMarkup||e.renderTrustedMarkup,i?i.call(e,e.none,s):l.call(e,"renderTrustedMarkup",e.none,s)))+"</div>\n	",r}this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),r=this.merge(r,e.partials),i=i||{};var s="",o,u="function",a=this.escapeExpression,f=this,l=n.helperMissing;o=n["if"].call(t,t.canCreateNew,{hash:{},inverse:f.noop,fn:f.program(1,c,i),data:i});if(o||o===0)s+=o;s+="\n",o=n["if"].call(t,t.albums,{hash:{},inverse:f.program(6,d,i),fn:f.program(3,h,i),data:i});if(o||o===0)s+=o;return s}),r={};e.Array.each(["album-selection-list-item"],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/album-selection-list",function(t,i){return i=i||{},i.partials=i.partials?e.merge(r,i.partials):r,n(t,i)})},"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-album-selection-list-item"]});
YUI.add("hermes-lang-shared-entity",function(e,t){e.Intl.add("hermes/shared-entity","en-US",{USERNAME_HAS_SHARED_PHOTOS_ONLY:["${username}"," has shared ",{type:"plural",valueName:"photoCount",options:{one:"${#} photo",other:"${#} photos"}}," with you!"],USERNAME_HAS_SHARED_VIDEOS_ONLY:["${username}"," has shared ",{type:"plural",valueName:"videoCount",options:{one:"${#} video",other:"${#} videos"}}," with you!"],USERNAME_HAS_SHARED_PHOTOS_VIDEOS:["${username}"," has shared ",{type:"plural",valueName:"photoCount",options:{one:"${#} photo",other:"${#} photos"}}," ",{type:"plural",valueName:"videoCount",options:{one:"and ${#} video",other:"and ${#} videos"}}," with you!"],OWNER_HAS_SHARED_PHOTOS_ONLY:["You have shared ",{type:"plural",valueName:"photoCount",options:{one:"${#} photo",other:"${#} photos"}},"."],OWNER_HAS_SHARED_VIDEOS_ONLY:["You have shared ",{type:"plural",valueName:"videoCount",options:{one:"${#} video",other:"${#} videos"}},"."],OWNER_HAS_SHARED_PHOTOS_VIDEOS:["You have shared ",{type:"plural",valueName:"photoCount",options:{one:"${#} photo",other:"${#} photos"}}," ",{type:"plural",valueName:"videoCount",options:{one:"and ${#} video",other:"and ${#} videos"}},"."],VIEW_YOUR_SHARING_HISTORY:["View your sharing history"]})},"@VERSION@",{requires:["intl"]});
YUI.add("flickr-favorites-getContext-fetcher",function(e,t){"use strict";function n(t){var n={photo_id:t.photoId,num_prev:t.numNext,num_next:t.numPrev,extras:e.APIHelper.request.getRebootPhotoExtras()};return t.id?n.user_id=t.id:n.path_alias=t.pathAlias,n}function r(t,n){var r=t[0],i=t[1],s=t[2],o=t[3],u=t[4],a=t[5],f=t[6],l=[],c=[],h=s.proxy(n.photoId),p,d,v,m,g,y,b=[];return p=r.prevphotos,d=r.nextphotos,c=e.APIHelper.response.parsePhotos({photos:p.photo,personModelRegistry:o,photoModelRegistry:s,photoEngagementModelRegistry:u,photoStatsModelRegistry:a,photoCurationModelRegistry:f}),l=e.APIHelper.response.parsePhotos({photos:d.photo,personModelRegistry:o,photoModelRegistry:s,photoEngagementModelRegistry:u,photoStatsModelRegistry:a,photoCurationModelRegistry:f}),y=i.getValue(n.id,"photoContextList"),m=y.hasMinBoundary?y.hasMinBoundary():!1,g=y.hasMaxBoundary?y.hasMaxBoundary():!1,v=y.getList(),b=e.APIHelper.response.addOrReplaceListByContext({model:h,next:c,prev:l.reverse(),hasMax:g,hasMin:m,current:v,numNext:n.numNext,numPrev:n.numPrev}),i.setValue(n.id,"photoContextList",b),{next:c,previous:l.reverse()}}function i(n,r){var i=this;return e.Promise.all([r.callAPI("flickr.favorites.getContext",this._processParams(n),!0),r.getModelRegistry("favorite-models"),r.getModelRegistry("photo-models"),r.getModelRegistry("person-models"),r.getModelRegistry("photo-engagement-models"),r.getModelRegistry("photo-stats-models"),r.getModelRegistry("photo-curation-models")]).then(function(e){return i._processResponse(e,n)},function(e){throw e.code===3&&e.message==="Photo not a favorite"&&(e.notInContext=!0),e}).then(null,e.FetcherErrorLogger(t))}e.namespace("ListFetchers")["flickr-favorites-getContext"]={run:i,_processParams:n,_processResponse:r}},"@VERSION@",{requires:["flickr-promise","api-helper","type-validator"],optional:["favorite-models","photo-models","person-models","photo-engagement-models","photo-stats-models","photo-curation-models"]});
